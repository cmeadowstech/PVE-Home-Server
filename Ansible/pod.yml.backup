---
- name: Preconfigure pod
  hosts: pod.home
  vars:
    user: pod
    apps:
      - name: arr
        docker: true
        pg_encoding: SQL_ASCII
        pg_databases:
          - sonarr-main
          - sonarr-log
          - radarr-main
          - radarr-log
          - prowlarr-main
          - prowlarr-log
          - jellyseerr
      - name: changedetection
        docker: true
  roles:
    - update
  tasks:
    - name: Create group - {{ user }}
      ansible.builtin.group:
        name: "{{ user }}"
        gid: 101111
        state: present

    - name: Create user - {{ user }}
      ansible.builtin.user:
        name: "{{ user }}"
        uid: 101111
        groups:
          - docker
          - "{{ user }}"
        append: true

- name: Set up pod
  hosts: pod.home
  gather_facts: false
  module_defaults:
    group/community.docker.docker:
      timeout: 120
  vars:
    user: pod
    apps: "{{ hostvars.vars.apps }}"
  roles:
    - docker_compose

- name: Set up Caddy
  hosts: firewall
  vars:
    caddy_dest: "{{ hostvars.vars.host_fqdn }}"
    apps: "{{ hostvars.vars.apps }}"
  roles:
    - caddy
    - dns
