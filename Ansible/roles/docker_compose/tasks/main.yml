---
- name: Download docker GPG key
  ansible.builtin.get_url:
    url: https://download.docker.com/linux/debian/gpg
    dest: /usr/share/keyrings/docker-keyring.asc
    mode: '0644'

- name: Add docker repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/usr/share/keyrings/docker-keyring.asc] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
    state: present

- name: Install apt dependencies
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 86400 # One day
    pkg:
      - docker-ce
      - docker-ce-cli
      - containerd.io
      - docker-buildx-plugin
      - docker-compose-plugin

- name: Create {{ app_name }} app folder
  ansible.builtin.file:
    path: "/src/{{ app_name }}"
    state: directory
    mode: '0750'
    owner: root
    group: docker

- name: Copy {{ app_name }} docker compose
  ansible.builtin.copy:
    src: "{{ app_name }}_docker-compose.yml"
    dest: "/src/{{ app_name }}/docker-compose.yml"
    mode: '0640'
    owner: root
    group: docker

- name: Create and start {{ app_name }} from docker-compose
  community.docker.docker_compose_v2:
    project_src: "/src/{{ app_name }}"
  register: compose_output
